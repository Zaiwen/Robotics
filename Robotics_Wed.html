<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>æœºå™¨äººç»Ÿä¸€æ§åˆ¶å¹³å°</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
        }

        h1 { color: #2c3e50; }
        #status { margin-bottom: 20px; font-weight: bold; }

        /* æœºå™¨äººé€‰æ‹©å™¨æ ·å¼ */
        .robot-selector-container {
            margin-bottom: 20px;
            padding: 10px 20px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            background-color: #ecf0f1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* ä¸»å®¹å™¨ï¼Œç”¨äºå·¦å³å¸ƒå±€ */
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-panel, .visualization-panel {
            padding: 20px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 400px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* é€‰é¡¹å¡æ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* é€Ÿåº¦æ§åˆ¶å¸ƒå±€ */
        .speed-control-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .linear-control, .angular-control {
            flex: 1;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .linear-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            max-width: 200px;
            margin: 0 auto;
        }

        .linear-grid button {
            width: 60px;
            height: 60px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .linear-up { grid-column: 2; grid-row: 1; }
        .linear-left { grid-column: 1; grid-row: 2; }
        .linear-stop { grid-column: 2; grid-row: 2; }
        .linear-right { grid-column: 3; grid-row: 2; }
        .linear-down { grid-column: 2; grid-row: 3; }

        /* ä¼˜åŒ–ï¼šè§’é€Ÿåº¦æŒ‰é’®æ”¹ä¸ºæ°´å¹³æ’åˆ— */
        .angular-buttons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 15px;
            max-width: none;
            margin: 0 auto;
        }

        .angular-buttons button {
            width: 120px;
            height: 60px;
            font-size: 18px;
        }

        /* æ˜¾ç¤ºåŒºåŸŸå››æ ¼å¸ƒå±€ */
        .display-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }

        .display-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .display-item h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        /* ç»Ÿä¸€æ˜¾ç¤ºå†…å®¹å®¹å™¨æ ·å¼ */
        .display-content { 
            width: 100%;
            height: 200px; /* å›ºå®šé«˜åº¦ï¼Œç¡®ä¿æ‰€æœ‰æ ¼å­ä¸€æ ·å¤§ */
            background-color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #34495e; 
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
            position: relative;
        }

        /* è§†é¢‘æµæ ·å¼ (é€‚ç”¨äº ROS è§†é¢‘å’Œ USB è§†é¢‘) */
        #video_display, #usb_video, .camera-stream {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
            background-color: #000;
            display: block;
        }

        /* 3D ç‚¹äº‘åŒºåŸŸæ ·å¼ */
        #cloud_display {
            width: 100%;
            height: 200px;
            background-color: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 4px;
        }
        .display-item:nth-child(2) #cloud_display {
            border: none;
        }
        
        /* æŒ‰é’®å’Œè¡¨æ ¼æ ·å¼ */
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 18px;
            border: 2px solid #3498db;
            border-radius: 5px;
            background-color: #3498db;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #2980b9; }
        table { margin: 0 auto; border-spacing: 5px; }

        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        /* API æ§åˆ¶æ ·å¼ */
        .api-control-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        #api_control_select {
            margin-right: 10px;
            width: 200px;
        }

        /* é€Ÿåº¦å‚æ•°æ ·å¼ */
        .speed-params {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* æœºæ¢°è‡‚æ§åˆ¶æ ·å¼ */
        .arm-control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .arm-control-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .arm-section-title {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.1em;
        }

        .arm-button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .arm-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .arm-btn-primary {
            background: #007bff;
            color: white;
        }

        .arm-btn-primary:hover {
            background: #0056b3;
        }

        .arm-btn-success {
            background: #28a745;
            color: white;
        }

        .arm-btn-success:hover {
            background: #1e7e34;
        }

        .arm-btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .arm-btn-warning:hover {
            background: #e0a800;
        }

        .arm-btn-danger {
            background: #dc3545;
            color: white;
        }

        .arm-btn-danger:hover {
            background: #c82333;
        }

        .arm-joint-control {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .arm-joint-select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .arm-joint-select-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .arm-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .arm-slider-container label {
            min-width: 80px;
            font-weight: 600;
            color: #495057;
        }

        .arm-angle-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #007bff;
        }

        .arm-incremental-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .arm-incremental-btn {
            padding: 8px;
            font-size: 12px;
        }

        .arm-status-messages {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .arm-status-message {
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 4px;
            background: white;
            border-left: 4px solid #007bff;
            font-size: 14px;
        }

        .arm-status-message.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .arm-status-message.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .arm-current-pose {
            background: #e7f3ff;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 12px;
        }

        /* G1æœºæ¢°è‡‚æ§åˆ¶æ ·å¼ */
        .g1-control-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }

        .g1-control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .g1-control-panel {
                grid-template-columns: 1fr;
            }
        }

        .g1-arm-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .g1-joint-control {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .g1-joint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .g1-joint-name {
            font-weight: bold;
            color: #34495e;
            font-size: 14px;
        }

        .g1-joint-value {
            font-weight: bold;
            color: #e74c3c;
            font-size: 14px;
        }

        .g1-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .g1-slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            transition: background 0.3s ease;
        }

        .g1-slider-container input[type="range"]:active {
            background: #3498db;
        }

        .g1-slider-container input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .g1-control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .g1-preset-section {
            grid-column: 1 / -1;
            background: #e8f4fc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .g1-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .g1-log-container {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .g1-log-entry {
            margin: 5px 0;
            padding: 3px;
            border-bottom: 1px solid #34495e;
        }

        .g1-timestamp {
            color: #3498db;
        }

        .g1-connection-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .g1-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .g1-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .g1-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .g1-connected .g1-status-indicator {
            background: #28a745;
        }

        .g1-disconnected .g1-status-indicator {
            background: #dc3545;
        }

        .g1-sending-indicator {
            color: #27ae60;
            font-size: 12px;
            margin-left: 5px;
            display: none;
        }

        .g1-sending .g1-sending-indicator {
            display: inline;
        }

        /* æœºå™¨äººç±»å‹ç‰¹å®šæ§åˆ¶ç•Œé¢ */
        .robot-specific-control {
            display: none;
        }

        .robot-specific-control.active {
            display: block;
        }

        /* æ§åˆ¶ç•Œé¢åˆ‡æ¢æç¤º */
        .control-hint {
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        /* G1æ‘„åƒå¤´æ ·å¼ */
        .g1-camera-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .g1-camera-item {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .g1-camera-item h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }

        .g1-camera-display {
            width: 100%;
            height: 200px;
            background-color: #000;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/roslib@1.0.1/build/roslib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.89.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>
    <h1>æœºå™¨äººç»Ÿä¸€æ§åˆ¶å¹³å°</h1>

    <div class="robot-selector-container">
        <label for="robot-select">é€‰æ‹©å½“å‰æ§åˆ¶çš„æœºå™¨äºº:</label>
        <select id="robot-select">
            </select>
    </div>

    <div id="status">ROS Bridge è¿æ¥çŠ¶æ€: <span id="status_text" style="color: red;">æœªè¿æ¥</span></div>

    <div class="main-container">
        <div class="control-panel">
            <h2>æœºå™¨äººæ§åˆ¶</h2>
            
            <div class="tabs">
                <button class="tab-button active" data-tab="speed-control">é€Ÿåº¦æ§åˆ¶</button>
                <button class="tab-button" data-tab="arm-control">æœºæ¢°è‡‚æ§åˆ¶</button>
                <button class="tab-button" data-tab="vla-control">VLAæ§åˆ¶</button>
            </div>
            
            <div id="speed-control" class="tab-content active">
                <div class="control-hint" id="speed-control-hint">
                    å½“å‰æ§åˆ¶æ¨¡å¼ï¼šå››è¶³æœºå™¨äººç§»åŠ¨æ§åˆ¶
                </div>
                
                <div class="speed-control-layout">
                    <div class="linear-control">
                        <h3>çº¿é€Ÿåº¦æ§åˆ¶ (WASDX)</h3>
                        <div class="linear-grid">
                            <button class="control-button linear-up" data-key="w" data-lin-x="1">â†‘</button>
                            <button class="control-button linear-left" data-key="a" data-lin-y="1">â†</button>
                            <button class="control-button linear-stop" data-key="s" data-lin-x="0" data-lin-y="0" data-ang-z="0">â—</button>
                            <button class="control-button linear-right" data-key="d" data-lin-y="-1">â†’</button>
                            <button class="control-button linear-down" data-key="x" data-lin-x="-1">â†“</button>
                        </div>
                    </div>
                    <div class="angular-control">
                        <h3>è§’é€Ÿåº¦æ§åˆ¶ (QE)</h3>
                        <div class="angular-buttons">
                            <button class="control-button angular-left" data-key="q" data-ang-z="1">â†¶ å·¦è½¬ (Q)</button>
                            <button class="control-button angular-right" data-key="e" data-ang-z="-1">â†· å³è½¬ (E)</button>
                        </div>
                    </div>
                </div>
                
                <div class="speed-params">
                    <p>
                        çº¿é€Ÿåº¦ x (m/s): <input type="number" id="linear_x_speed" value="0.5" step="0.1" style="width: 70px;"> |
                        çº¿é€Ÿåº¦ y (m/s): <input type="number" id="linear_y_speed" value="0.3" step="0.1" style="width: 70px;"> |
                        è§’é€Ÿåº¦ z (rad/s): <input type="number" id="angular_z_speed" value="0.5" step="0.1" style="width: 70px;">
                    </p>
                </div>
                
                <div class="api-control-section">
                    <h2>è¿åŠ¨æ§åˆ¶ (API) - /api/sport/request</h2>
                    <select id="api_control_select"></select>
                    <button id="send_api_button">å‘é€ API æŒ‡ä»¤</button>
                </div>
            </div>
            
            <div id="arm-control" class="tab-content">
                <div class="control-hint" id="arm-control-hint">
                    è¯·é€‰æ‹©æœºå™¨äººç±»å‹ä»¥æ˜¾ç¤ºç›¸åº”çš„æœºæ¢°è‡‚æ§åˆ¶ç•Œé¢
                </div>
                
                <!-- GO2 æœºæ¢°è‡‚æ§åˆ¶ç•Œé¢ -->
                <div id="go2-arm-control" class="robot-specific-control">
                    <div class="arm-control-grid">
                        <div class="arm-control-section">
                            <h3 class="arm-section-title">ğŸ”§ åŸºç¡€æ§åˆ¶</h3>
                            <div class="arm-button-group">
                                <button onclick="armSendCommand('enable')" class="arm-btn arm-btn-success">
                                    ğŸ”“ ä½¿èƒ½æœºæ¢°è‡‚
                                </button>
                                <button onclick="armSendCommand('disable')" class="arm-btn arm-btn-danger">
                                    ğŸ”’ ç¦ç”¨æœºæ¢°è‡‚
                                </button>
                                <button onclick="armSendCommand('home')" class="arm-btn arm-btn-primary">
                                    ğŸ  å›é›¶ä½ç½®
                                </button>
                            </div>
                        </div>

                        <div class="arm-control-section">
                            <h3 class="arm-section-title">ğŸ–ï¸ å¤¹çˆªæ§åˆ¶ (0-65mm)</h3>
                            <div class="arm-button-group">
                                <button onclick="armSetGripperPosition(65)" class="arm-btn arm-btn-danger">
                                    ğŸ”¤ å…¨å¼€ (0mm)
                                </button>
                                <button onclick="armSetGripperPosition(32.5)" class="arm-btn arm-btn-warning">
                                    âš–ï¸ åŠå¼€ (32.5mm)
                                </button>
                                <button onclick="armSetGripperPosition(0)" class="arm-btn arm-btn-success">
                                    ğŸ”¥ å…¨é—­ (65mm)
                                </button>
                            </div>
                        </div>

                        <div class="arm-control-section">
                            <h3 class="arm-section-title">ğŸ¯ é¢„è®¾å§¿åŠ¿</h3>
                            <div class="arm-button-group">
                                <button onclick="armSendPresetPose1()" class="arm-btn arm-btn-primary">
                                    æŠ“å–å§¿åŠ¿
                                </button>
                                <button onclick="armSendPresetPose2()" class="arm-btn arm-btn-primary">
                                    æ”¾ç½®å§¿åŠ¿
                                </button>
                                <button onclick="armSendPresetPose3()" class="arm-btn arm-btn-primary">
                                    ä¼¸å±•å§¿åŠ¿
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="arm-control-section">
                        <h3 class="arm-section-title">ğŸ›ï¸ å¤¹çˆªç²¾ç¡®æ§åˆ¶</h3>
                        <div class="arm-slider-container">
                            <label>å¤¹çˆªä½ç½®:</label>
                            <input type="range" id="arm_gripper_slider" min="0" max="65" value="0" step="0.5"
                                   oninput="armUpdateGripperValue(this.value)">
                            <span class="arm-angle-value" id="arm_gripper_value">0mm</span>
                            <button onclick="armSetGripperPosition(parseFloat(document.getElementById('arm_gripper_slider').value))" class="arm-btn arm-btn-primary arm-btn-sm">
                                â¡ï¸ è®¾ç½®
                            </button>
                        </div>
                    </div>

                    <div class="arm-control-section">
                        <h3 class="arm-section-title">ğŸ”¢ å•å…³èŠ‚æ§åˆ¶</h3>
                        <div class="arm-joint-control">
                            <div class="arm-joint-select-group">
                                <label>é€‰æ‹©å…³èŠ‚:</label>
                                <select id="arm_joint_select">
                                    <option value="0">å…³èŠ‚ 0 - åŸºåº§ (Â±135Â°)</option>
                                    <option value="1">å…³èŠ‚ 1 - è‚©éƒ¨ (Â±90Â°)</option>
                                    <option value="2">å…³èŠ‚ 2 - è‚˜éƒ¨ (Â±90Â°)</option>
                                    <option value="3">å…³èŠ‚ 3 - è…•éƒ¨1 (Â±135Â°)</option>
                                    <option value="4">å…³èŠ‚ 4 - è…•éƒ¨2 (Â±90Â°)</option>
                                    <option value="5">å…³èŠ‚ 5 - è…•éƒ¨3 (Â±135Â°)</option>
                                </select>
                            </div>
                            <div class="arm-joint-select-group">
                                <label>ç›®æ ‡è§’åº¦ (Â°):</label>
                                <input type="number" id="arm_joint_angle" value="0" min="-135" max="135" step="1">
                            </div>
                            <div>
                                <button onclick="armMoveJointAbsolute()" class="arm-btn arm-btn-primary" style="width: 100%;">
                                    â¡ï¸ ç»å¯¹ç§»åŠ¨
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="arm-control-section">
                        <h3 class="arm-section-title">ğŸ”„ å¢é‡æ§åˆ¶ (Â±5Â°)</h3>
                        <div class="arm-incremental-buttons">
                            <button onclick="armMoveAllJointsIncremental([5, 0, 0, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â¡ï¸ æ•´ä½“å³è½¬
                            </button>
                            <button onclick="armMoveAllJointsIncremental([-5, 0, 0, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â¬…ï¸ æ•´ä½“å·¦è½¬
                            </button>
                            <button onclick="armMoveAllJointsIncremental([0, 5, 0, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â¬†ï¸ è‚©éƒ¨ä¸ŠæŠ¬
                            </button>
                            <button onclick="armMoveAllJointsIncremental([0, -5, 0, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â¬‡ï¸ è‚©éƒ¨ä¸‹å‹
                            </button>
                            <button onclick="armMoveAllJointsIncremental([0, 0, 5, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â†—ï¸ è‚˜éƒ¨ä¼¸å±•
                            </button>
                            <button onclick="armMoveAllJointsIncremental([0, 0, -5, 0, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                â†™ï¸ è‚˜éƒ¨æ”¶ç¼©
                            </button>
                            <button onclick="armMoveAllJointsIncremental([0, 0, 0, 5, 0, 0, 0])" class="arm-btn arm-btn-warning arm-incremental-btn">
                                ğŸ”„ è…•éƒ¨æ—‹è½¬
                            </button>
                            <button onclick="armMoveAllJointsIncremental([2, 2, 2, 0, 0, 0, 0])" class="arm-btn arm-btn-success arm-incremental-btn">
                                ğŸš€ æ•´ä½“ä¼¸å±•
                            </button>
                        </div>
                    </div>

                    <div class="arm-control-section">
                        <h3 class="arm-section-title">ğŸ® å¤šå…³èŠ‚æ§åˆ¶</h3>
                        <div class="arm-button-group" style="margin-top: 10px;">
                            <button onclick="armSendCustomPose()" class="arm-btn arm-btn-warning">
                                ğŸ“ å‘é€è‡ªå®šä¹‰å§¿åŠ¿
                            </button>
                            <button onclick="armRequestCurrentState()" class="arm-btn arm-btn-primary">
                                ğŸ“Š åˆ·æ–°ä½ç½®
                            </button>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>è‡ªå®šä¹‰è§’åº¦ (7ä¸ªå…³èŠ‚):</label>
                            <input type="text" id="arm_custom_angles" placeholder="[0, -45, 60, 0, 30, 0, 0]" 
                                   style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666;">æ ¼å¼: [è§’åº¦0, è§’åº¦1, è§’åº¦2, è§’åº¦3, è§’åº¦4, è§’åº¦5, è§’åº¦6]</small>
                        </div>
                    </div>

                    <div class="arm-status-messages" id="arm_status_messages">
                        <div class="arm-status-message">
                            <span class="log-timestamp" id="arm_current_time"></span>
                            ç­‰å¾…è¿æ¥...
                        </div>
                    </div>
                </div>
                
                <!-- G1 æœºæ¢°è‡‚æ§åˆ¶ç•Œé¢ -->
                <div id="g1-arm-control" class="robot-specific-control">
                    <div class="g1-control-section">
                        <h2>ğŸ¤– G1æœºæ¢°è‡‚è¿œç¨‹æ§åˆ¶ç³»ç»Ÿ</h2>
                        <p>åŸºäºMQTT WebSocketçš„å®æ—¶æ§åˆ¶ç•Œé¢ - æ‹–åŠ¨æ»‘å—å®æ—¶æ§åˆ¶</p>
                        
                        <div class="g1-connection-status g1-disconnected" id="g1_connectionStatus">
                            <span class="g1-status-indicator"></span>
                            <span id="g1_statusText">æœªè¿æ¥åˆ°MQTTæœåŠ¡å™¨</span>
                        </div>
                        <div class="g1-control-buttons">
                            <button class="success" onclick="g1EnableArm()">ğŸŸ¢ å¯ç”¨æœºæ¢°è‡‚</button>
                            <button class="danger" onclick="g1DisableArm()">ğŸ”´ ç¦ç”¨æœºæ¢°è‡‚</button>
                            <button onclick="g1SendAllJoints()">ğŸ“¤ å‘é€æ‰€æœ‰å…³èŠ‚</button>
                            <button onclick="g1StopArm()">ğŸ›‘ ç´§æ€¥åœæ­¢</button>
                            <button onclick="g1ClearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                        </div>
                    </div>

                    <div class="g1-control-panel">
                        <!-- å·¦è‡‚æ§åˆ¶ -->
                        <div class="g1-arm-section">
                            <h2>ğŸ«² å·¦è‡‚æ§åˆ¶ (7ä¸ªå…³èŠ‚)</h2>
                            <div id="g1_leftArmControls">
                                <!-- å·¦è‡‚å…³èŠ‚æ§åˆ¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- å³è‡‚æ§åˆ¶ -->
                        <div class="g1-arm-section">
                            <h2>ğŸ«± å³è‡‚æ§åˆ¶ (7ä¸ªå…³èŠ‚)</h2>
                            <div id="g1_rightArmControls">
                                <!-- å³è‡‚å…³èŠ‚æ§åˆ¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- é¢„è®¾åŠ¨ä½œ -->
                        <div class="g1-preset-section">
                            <h2>ğŸ¯ é¢„è®¾åŠ¨ä½œ</h2>
                            <div class="g1-preset-grid">
                                <button onclick="g1SendPreset('home')">ğŸ  å½’ä½å§¿åŠ¿</button>
                                <button onclick="g1SendPreset('stretch')">ğŸ“ æ°´å¹³ä¼¸ç›´</button>
                                <button onclick="g1SendPreset('wave_left')">ğŸ‘‹ å·¦è‡‚æŒ¥æ‰‹</button>
                                <button onclick="g1SendPreset('wave_right')">ğŸ‘‹ å³è‡‚æŒ¥æ‰‹</button>
                                <button onclick="g1SendPreset('grab')">ğŸ–ï¸ æŠ“å–å§¿åŠ¿</button>
                                <button onclick="g1SendPreset('zero')">0ï¸âƒ£ é›¶ä½å§¿åŠ¿</button>
                                <button onclick="g1SendPreset('salute')">âœ‹ æ•¬ç¤¼å§¿åŠ¿</button>
                                <button onclick="g1SendPreset('tpose')">ğŸ•´ï¸ Tå‹å§¿åŠ¿</button>
                                <button onclick="g1SendPreset('relax')">ğŸ˜Œ æ”¾æ¾å§¿åŠ¿</button>
                            </div>
                        </div>

                        <!-- è‡ªå®šä¹‰å‘½ä»¤ -->
                        <div class="g1-preset-section">
                            <h2>ğŸ”§ è‡ªå®šä¹‰å‘½ä»¤</h2>
                            <div class="command-form">
                                <div class="form-group">
                                    <label for="g1_jointSelect">é€‰æ‹©å…³èŠ‚:</label>
                                    <select id="g1_jointSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <!-- å…³èŠ‚é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="g1_positionInput">ç›®æ ‡ä½ç½® (å¼§åº¦):</label>
                                    <input type="number" id="g1_positionInput" step="0.01" value="0.0" onchange="g1SendSingleJoint()">
                                </div>
                                <button onclick="g1SendSingleJoint()">å‘é€å•ä¸ªå…³èŠ‚å‘½ä»¤</button>
                            </div>
                        </div>

                        <!-- ç³»ç»Ÿæ—¥å¿— -->
                        <div class="g1-log-container">
                            <h3 style="color: white; margin-bottom: 10px;">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
                            <div id="g1_logContent">
                                <div class="g1-log-entry"><span class="g1-timestamp">[ç³»ç»Ÿ]</span> ç­‰å¾…è¿æ¥...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="vla-control" class="tab-content">
                <h3>TODO: VLAæ§åˆ¶ç•Œé¢</h3>
                <p>VLAæ§åˆ¶åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
            </div>
        </div>

        <div class="visualization-panel">
            <h2>ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–</h2>
            
            <!-- æœºå™¨äººæ‘„åƒå¤´å’Œé›·è¾¾æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="display-grid">
                <div class="display-item">
                    <h3>æœºå™¨äººæ‘„åƒå¤´</h3>
                    <div class="display-content" style="background-color: #000; border: none;">
                        <img id="video_display" src="" alt="ROS Video Stream" class="camera-stream" />
                    </div>
                    <button class="save-btn" onclick="saveCameraImage('video_display', 'robot_camera')">ä¿å­˜å›¾åƒ</button>
                </div>
                
                <div class="display-item">
                    <h3>æœºå™¨äººé›·è¾¾</h3>
                    <div id="cloud_display" class="display-content"></div> 
                    <button class="save-btn">ä¿å­˜ç‚¹äº‘</button>
                </div>
                
                <!-- GO2æœºæ¢°è‡‚æ‘„åƒå¤´ -->
                <div class="display-item" id="go2-arm-camera-item">
                    <h3>æœºæ¢°è‡‚æ‘„åƒå¤´</h3>
                    <div class="display-content" style="background-color: #000; border: none;">
                        <img id="arm_video_feed" src="" alt="æœºæ¢°è‡‚æ‘„åƒå¤´" class="camera-stream">
                    </div>
                    <button class="save-btn" onclick="saveCameraImage('arm_video_feed', 'arm_camera')">ä¿å­˜å›¾åƒ</button>
                </div>
                
                <div class="display-item">
                    <h3>å…¨å±€æ‘„åƒå¤´ <button id="open_usb_cam" style="font-size: 14px; padding: 2px 4px;">æ‰“å¼€</button></h3>
                    <div class="display-content" style="background-color: #000;">
                        <video id="usb_video" autoplay playsinline muted></video>
                    </div>
                    <button id="save_usb_btn" class="save-btn" disabled style="background-color: #7f8c8d; border-color: #7f8c8d; cursor: not-allowed;">ä¿å­˜å›¾åƒ</button>
                </div>
            </div>

            <!-- G1å·¦å³æ‘„åƒå¤´æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="g1-camera-container" id="g1-camera-container">
                <div class="g1-camera-item">
                    <h3>G1å·¦æ‘„åƒå¤´</h3>
                    <div class="g1-camera-display">
                        <img id="g1_left_camera" src="" alt="G1å·¦æ‘„åƒå¤´" class="camera-stream">
                    </div>
                    <button class="save-btn" onclick="saveCameraImage('g1_left_camera', 'g1_left_camera')">ä¿å­˜å›¾åƒ</button>
                </div>
                <div class="g1-camera-item">
                    <h3>G1å³æ‘„åƒå¤´</h3>
                    <div class="g1-camera-display">
                        <img id="g1_right_camera" src="" alt="G1å³æ‘„åƒå¤´" class="camera-stream">
                    </div>
                    <button class="save-btn" onclick="saveCameraImage('g1_right_camera', 'g1_right_camera')">ä¿å­˜å›¾åƒ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================================
        // !!! å¿… é¡» ä¿® æ”¹ çš„ é… ç½®: æœºå™¨äººåˆ—è¡¨ !!!
        // ==========================================================
        const ROBOTS_CONFIG = {
            'GO2 (18)': {
                ip: '192.168.1.18',
                video_port: 5000,
                arm_camera_port: 5001,  // æ·»åŠ æœºæ¢°è‡‚æ‘„åƒå¤´ç«¯å£
                type: 'go2'
            },
            'GO2 (19)': {
                ip: '192.168.1.19',
                video_port: 5000,
                arm_camera_port: 5001,  // æ·»åŠ æœºæ¢°è‡‚æ‘„åƒå¤´ç«¯å£
                type: 'go2'
            },
            'G1 (20)': {
                ip: '192.168.1.20',
                video_port: 5000,
                left_camera_port: 5001,
                right_camera_port: 5002,
                type: 'g1'
            },
            'æµ‹è¯•': {
                ip: '192.168.123.18',
                video_port: 5000,
                arm_camera_port: 5001,  // æ·»åŠ æœºæ¢°è‡‚æ‘„åƒå¤´ç«¯å£
                type: 'go2'
            },
        };

        // --- ROS è¿æ¥å¸¸é‡ ---
        const ROSBRIDGE_PORT = 9090;
        const CMD_VEL_TOPIC = '/cmd_vel';
        const POINT_CLOUD_TOPIC = '/utlidar/cloud';
        const SPORT_API_TOPIC = '/api/sport/request';
        const SPORT_API_MSG_TYPE = 'unitree_api/msg/Request';
        
        // æ ¸å¿ƒæ–°å¢å¸¸é‡ï¼šæœ€å¤§é‡è¿å°è¯•æ¬¡æ•°
        const MAX_RECONNECT_ATTEMPTS = 3; 

        // æ–°å¢ API å€¼å­—å…¸ (çœç•¥)
        const ROBOT_SPORT_API_IDS = {
            "DAMP": 1001, "BALANCESTAND": 1002, "STOPMOVE": 1003, "STANDUP": 1004, "STANDDOWN": 1005,
            "RECOVERYSTAND": 1006, "EULER": 1007, "MOVE": 1008, "SIT": 1009, "RISESIT": 1010,
            "SPEEDLEVEL": 1015, "HELLO": 1016, "STRETCH": 1017, "CONTENT": 1020, "DANCE1": 1022,
            "DANCE2": 1023, "GETBODYHEIGHT": 1024, "GETFOOTRAISEHEIGHT": 1025, "GETSPEEDLEVEL": 1026,
            "SWITCHJOYSTICK": 1027, "POSE": 1028, "SCRAPE": 1029, "FRONTFLIP": 1030, "FRONTJUMP": 1031,
            "FRONTPOUNCE": 1032, "STATICWALK": 1061, "TROTRUN": 1062, "ECONOMICGAIT": 1063,
            "LEFTFLIP": 2041, "BACKFLIP": 2043, "HANDSTAND": 2044, "FREEWALK": 2045, "FREEBOUND": 2046,
            "FREEJUMP": 2047, "FREEAVOID": 2048, "CLASSICWALK": 2049, "WALKUPRIGHT": 2050,
            "CROSSSTEP": 2051, "AUTORECOVERY_SET": 2054, "AUTORECOVERY_GET": 2055, "SWITCHAVOIDMODE": 2058,
        };

        // --- å¯è§†åŒ–å¸¸é‡ (ä¿æŒä¸å˜) ---
        const POINT_SIZE = 0.15;
        const COLOR_MAP_MIN_DISTANCE = 0.5;
        const COLOR_MAP_MAX_DISTANCE = 15.0;

        // --- å…¨å±€å˜é‡ ---
        let ros = null;
        let cmdVel = null;
        let cloudTopicSubscriber = null;
        let sportApiTopic = null;
        let currentRobotConfig = null;

        let scene, camera, renderer, controls;
        let pointCloudObject = null;

        const statusText = document.getElementById('status_text');
        const cloudDiv = document.getElementById('cloud_display');
        const videoDisplay = document.getElementById('video_display');
        const armVideoDisplay = document.getElementById('arm_video_feed'); // æœºæ¢°è‡‚æ‘„åƒå¤´æ˜¾ç¤º
        const robotSelect = document.getElementById('robot-select');
        const apiControlSelect = document.getElementById('api_control_select');

        const color = new THREE.Color();
        let currentLinearX = 0.0;
        let currentLinearY = 0.0;
        let currentAngularZ = 0.0;
        let keysPressed = {};
        
        // æ ¸å¿ƒæ ‡å¿— 1: ç”¨äºæ§åˆ¶è‡ªåŠ¨é‡è¿çš„è®¡æ—¶å™¨ ID
        let reconnectTimerId = null; 
        // æ ¸å¿ƒæ ‡å¿— 2: æ ‡è®°å½“å‰æ˜¯å¦å¤„äº"æ­£åœ¨å°è¯•é‡è¿"çš„çŠ¶æ€
        let isAttemptingReconnect = false; 
        // æ ¸å¿ƒæ ‡å¿— 3: æ ‡è®°æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ“ä½œ (switchRobot)
        let isManualOperation = false;
        // æ ¸å¿ƒæ–°å¢å˜é‡ï¼šå½“å‰é‡è¿å°è¯•æ¬¡æ•°
        let currentReconnectAttempts = 0; 

        // ==========================================================
        // æœºæ¢°è‡‚æ§åˆ¶ç›¸å…³å˜é‡å’Œå‡½æ•°
        // ==========================================================
        // MQTTé…ç½®
        const ARM_MQTT_CONFIG = {
            hostname: 'broker.emqx.io',
            port: 8083,
            path: '/mqtt',
            protocol: 'ws',
            clientId: 'web_arm_control_' + Math.random().toString(16).substr(2, 8),
            topicCmd: 'jetson/arm_cmd',
            topicResult: 'jetson/arm_result',
            topicState: 'jetson/arm_state',
            topicCameraCmd: 'jetson/camera_cmd'
        };

        let armMqttClient = null;
        let isArmConnected = false;
        let armCurrentPose = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]; // å½“å‰æœºæ¢°è‡‚å§¿åŠ¿
        let armCurrentGripperPos = 0; // å½“å‰å¤¹çˆªä½ç½® (0-65mm)

        // å…³èŠ‚é™åˆ¶ [J0, J1, J2, J3, J4, J5, å¤¹çˆª]
        const ARM_JOINT_LIMITS = [135, 90, 90, 135, 90, 135, 65];

        // æœºæ¢°è‡‚æ§åˆ¶å‡½æ•°
        function armUpdateGripperValue(value) {
            armCurrentGripperPos = parseFloat(value);
            document.getElementById('arm_gripper_value').textContent = value + 'mm';
        }

        function armSetGripperPosition(position) {
            armCurrentGripperPos = position;
            document.getElementById('arm_gripper_slider').value = position;
            document.getElementById('arm_gripper_value').textContent = position + 'mm';
            
            armSendCommand('gripper_position', { position: position });
        }

        function armMoveJointAbsolute() {
            const jointId = parseInt(document.getElementById('arm_joint_select').value);
            const angle = parseFloat(document.getElementById('arm_joint_angle').value);
            
            // éªŒè¯è§’åº¦èŒƒå›´
            if (Math.abs(angle) > ARM_JOINT_LIMITS[jointId]) {
                armAddStatusMessage(`âŒ å…³èŠ‚${jointId}è§’åº¦è¶…å‡ºèŒƒå›´ Â±${ARM_JOINT_LIMITS[jointId]}Â°`, 'error');
                return;
            }
            
            armSendCommand('move_joint', { joint_id: jointId, angle: angle });
            
            // æ›´æ–°å½“å‰å§¿åŠ¿æ˜¾ç¤º
            armCurrentPose[jointId] = angle;
            armUpdateCurrentPoseDisplay();
            
            armAddStatusMessage(`âœ… å…³èŠ‚ ${jointId} ç§»åŠ¨åˆ° ${angle}Â°`, 'success');
        }

        function armMoveAllJointsIncremental(increments) {
            const newPose = armCurrentPose.map((angle, index) => {
                const increment = increments[index] || 0;
                const newAngle = angle + increment;
                // é™åˆ¶åœ¨å…³èŠ‚èŒƒå›´å†…
                return Math.max(-ARM_JOINT_LIMITS[index], Math.min(ARM_JOINT_LIMITS[index], newAngle));
            });
            
            armSendCommand('move_all_joints', { angles: newPose });
            
            // æ›´æ–°å½“å‰å§¿åŠ¿
            armCurrentPose = newPose;
            armUpdateCurrentPoseDisplay();
            
            armAddStatusMessage(`âœ… å¢é‡ç§»åŠ¨: ${increments.map(i => i.toFixed(1)).join(', ')}`, 'success');
        }

        function armSendCustomPose() {
            const input = document.getElementById('arm_custom_angles').value.trim();
            try {
                const angles = JSON.parse(input);
                if (!Array.isArray(angles) || angles.length !== 7) {
                    armAddStatusMessage('âŒ è¯·è¾“å…¥7ä¸ªå…³èŠ‚è§’åº¦çš„æ•°ç»„', 'error');
                    return;
                }
                
                // éªŒè¯æ¯ä¸ªè§’åº¦
                for (let i = 0; i < 7; i++) {
                    if (Math.abs(angles[i]) > ARM_JOINT_LIMITS[i]) {
                        armAddStatusMessage(`âŒ å…³èŠ‚${i}è§’åº¦${angles[i]}è¶…å‡ºèŒƒå›´ Â±${ARM_JOINT_LIMITS[i]}Â°`, 'error');
                        return;
                    }
                }
                
                armSendCommand('move_all_joints', { angles: angles });
                
                // æ›´æ–°å½“å‰å§¿åŠ¿
                armCurrentPose = angles;
                armUpdateCurrentPoseDisplay();
                
                armAddStatusMessage('âœ… å‘é€è‡ªå®šä¹‰å§¿åŠ¿: ' + JSON.stringify(angles), 'success');
            } catch (e) {
                armAddStatusMessage('âŒ è§’åº¦æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨JSONæ•°ç»„æ ¼å¼', 'error');
            }
        }

        function armRequestCurrentState() {
            armSendCommand('get_state');
        }

        function armUpdateCurrentPoseDisplay() {
            const displayPose = armCurrentPose.map(angle => angle.toFixed(1));
            document.getElementById('currentPose').textContent = 
                'å½“å‰å§¿åŠ¿: [' + displayPose.join(', ') + ']';
        }

        function armSendPresetPose1() {
            const pose = [0, -45, 60, 0, 30, 0, 0];
            armSendCommand('move_all_joints', { angles: pose });
            armCurrentPose = pose;
            armUpdateCurrentPoseDisplay();
            armAddStatusMessage('âœ… å‘é€æŠ“å–å§¿åŠ¿', 'success');
        }

        function armSendPresetPose2() {
            const pose = [30, -30, 45, -15, 20, 10, 0];
            armSendCommand('move_all_joints', { angles: pose });
            armCurrentPose = pose;
            armUpdateCurrentPoseDisplay();
            armAddStatusMessage('âœ… å‘é€æ”¾ç½®å§¿åŠ¿', 'success');
        }

        function armSendPresetPose3() {
            const pose = [45, -60, 30, -10, 15, 5, 0];
            armSendCommand('move_all_joints', { angles: pose });
            armCurrentPose = pose;
            armUpdateCurrentPoseDisplay();
            armAddStatusMessage('âœ… å‘é€ä¼¸å±•å§¿åŠ¿', 'success');
        }

        // æœºæ¢°è‡‚MQTTè¿æ¥
        function armConnectMQTT() {
            try {
                armUpdateConnectionStatus('connecting', 'ğŸŸ¡ è¿æ¥ä¸­...');
                
                armMqttClient = mqtt.connect(ARM_MQTT_CONFIG);
                
                armMqttClient.on('connect', () => {
                    isArmConnected = true;
                    armUpdateConnectionStatus('connected', 'âœ… å·²è¿æ¥åˆ°MQTTæœåŠ¡å™¨');
                    
                    // è®¢é˜…ç»“æœå’ŒçŠ¶æ€ä¸»é¢˜
                    armMqttClient.subscribe(ARM_MQTT_CONFIG.topicResult);
                    armMqttClient.subscribe(ARM_MQTT_CONFIG.topicState);
                    
                    armAddStatusMessage('MQTTè¿æ¥æˆåŠŸï¼Œå¯ä»¥æ§åˆ¶æœºæ¢°è‡‚');
                    
                    // è¯·æ±‚åˆå§‹çŠ¶æ€
                    setTimeout(() => armRequestCurrentState(), 500);
                });

                armMqttClient.on('message', (topic, message) => {
                    const msg = message.toString();
                    
                    if (topic === ARM_MQTT_CONFIG.topicResult) {
                        armAddStatusMessage('æœºæ¢°è‡‚: ' + msg, 'success');
                    } else if (topic === ARM_MQTT_CONFIG.topicState) {
                        try {
                            const state = JSON.parse(msg);
                            if (state.joint_angles && Array.isArray(state.joint_angles)) {
                                armCurrentPose = state.joint_angles;
                                armUpdateCurrentPoseDisplay();
                                armAddStatusMessage('ğŸ“Š çŠ¶æ€æ›´æ–°: ' + JSON.stringify(state.joint_angles.map(a => a.toFixed(1))));
                            }
                        } catch (e) {
                            console.error('çŠ¶æ€è§£æé”™è¯¯:', e);
                        }
                    }
                });

                armMqttClient.on('error', (error) => {
                    isArmConnected = false;
                    armUpdateConnectionStatus('error', 'âŒ è¿æ¥é”™è¯¯');
                    armAddStatusMessage('MQTTé”™è¯¯: ' + error, 'error');
                });

                armMqttClient.on('close', () => {
                    isArmConnected = false;
                    armUpdateConnectionStatus('disconnected', 'ğŸ”´ è¿æ¥å·²æ–­å¼€');
                    armAddStatusMessage('MQTTè¿æ¥å·²æ–­å¼€ï¼Œ5ç§’åè‡ªåŠ¨é‡è¿...', 'error');
                    
                    // 5ç§’åè‡ªåŠ¨é‡è¿
                    setTimeout(() => {
                        if (!isArmConnected) {
                            armAddStatusMessage('æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...', 'success');
                            armReconnect();
                        }
                    }, 5000);
                });

            } catch (error) {
                armUpdateConnectionStatus('error', 'âŒ è¿æ¥å¤±è´¥');
                armAddStatusMessage('è¿æ¥å¼‚å¸¸: ' + error, 'error');
            }
        }

        // å‘é€æœºæ¢°è‡‚å‘½ä»¤
        function armSendCommand(action, params = {}) {
            if (!isArmConnected || !armMqttClient) {
                armAddStatusMessage('âŒ æœªè¿æ¥åˆ°MQTTæœåŠ¡å™¨', 'error');
                return;
            }

            const message = {
                action: action,
                params: params,
                timestamp: Date.now()
            };

            armMqttClient.publish(ARM_MQTT_CONFIG.topicCmd, JSON.stringify(message));
            armAddStatusMessage(`ğŸ“¤ å‘é€æŒ‡ä»¤: ${action}`, 'success');
        }

        // é‡æ–°è¿æ¥æœºæ¢°è‡‚
        function armReconnect() {
            armAddStatusMessage('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥...', 'success');
            if (armMqttClient) {
                try {
                    armMqttClient.end(true);  // å¼ºåˆ¶å…³é—­
                } catch (e) {
                    console.log('å…³é—­æ—§è¿æ¥æ—¶å‡ºé”™:', e);
                }
            }
            setTimeout(() => {
                armConnectMQTT();
            }, 500);
        }

        // æ›´æ–°æœºæ¢°è‡‚è¿æ¥çŠ¶æ€
        function armUpdateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const textEl = document.getElementById('connectionText');
            
            if (indicator && textEl) {
                indicator.className = 'status-indicator ' + status;
                textEl.textContent = text;
            }
        }

        // æ·»åŠ æœºæ¢°è‡‚çŠ¶æ€æ¶ˆæ¯
        function armAddStatusMessage(message, type = '') {
            const container = document.getElementById('arm_status_messages');
            if (!container) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `arm-status-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<span class="log-timestamp">${timestamp}</span>${message}`;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            
            // é™åˆ¶æ¶ˆæ¯æ•°é‡
            const messages = container.getElementsByClassName('arm-status-message');
            if (messages.length > 30) {
                messages[0].remove();
            }
        }

        // å‘é€æœºæ¢°è‡‚æ‘„åƒå¤´å‘½ä»¤
        function armSendCameraCommand(action, params = {}) {
            if (!isArmConnected || !armMqttClient) {
                armAddStatusMessage('âŒ æœªè¿æ¥åˆ°MQTTæœåŠ¡å™¨', 'error');
                return;
            }

            const message = {
                action: action,
                ...params,
                timestamp: Date.now()
            };

            armMqttClient.publish(ARM_MQTT_CONFIG.topicCameraCmd, JSON.stringify(message));
        }

        // åˆå§‹åŒ–æœºæ¢°è‡‚æ§åˆ¶
        function armInitPage() {
            armUpdateTime();
            armConnectMQTT();
            armUpdateCurrentPoseDisplay();
            
            // æ¯ç§’æ›´æ–°æ—¶é—´
            setInterval(armUpdateTime, 1000);
        }

        // æ›´æ–°æœºæ¢°è‡‚æ—¶é—´æ˜¾ç¤º
        function armUpdateTime() {
            const timeEl = document.getElementById('arm_current_time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleTimeString();
            }
        }

        // ==========================================================
        // G1æœºæ¢°è‡‚æ§åˆ¶ç›¸å…³å˜é‡å’Œå‡½æ•° - ä¿®å¤åçš„MQTTè¿æ¥
        // ==========================================================
        // MQTTé…ç½® - ä¿®æ”¹ä¸ºä¸ç¬¬äºŒä¸ªæ–‡ä»¶ä¸€è‡´
        const G1_MQTT_CONFIG = {
            broker: 'broker.emqx.io',
            port: 8083,
            topicCmd: 'g1/arm_control',
            topicState: 'g1/arm_state',
            clientId: 'g1_dual_camera_controller_' + Math.random().toString(16).substr(2, 8)  // ä½¿ç”¨æ›´é•¿çš„éšæœºID
        };

        // å…³èŠ‚é…ç½® - 14ä¸ªæ‰‹è‡‚å…³èŠ‚
        const G1_JOINT_CONFIG = {
            leftArm: [
                { id: 'left_shoulder_pitch', name: 'å·¦è‚©ä¿¯ä»°', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_shoulder_roll', name: 'å·¦è‚©æ—‹è½¬', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_shoulder_yaw', name: 'å·¦è‚©åèˆª', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_elbow', name: 'å·¦è‚˜å…³èŠ‚', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_wrist_roll', name: 'å·¦è…•æ—‹è½¬', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_wrist_pitch', name: 'å·¦è…•ä¿¯ä»°', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'left_wrist_yaw', name: 'å·¦è…•åèˆª', min: -3.14, max: 3.14, step: 0.01, value: 0.0 }
            ],
            rightArm: [
                { id: 'right_shoulder_pitch', name: 'å³è‚©ä¿¯ä»°', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_shoulder_roll', name: 'å³è‚©æ—‹è½¬', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_shoulder_yaw', name: 'å³è‚©åèˆª', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_elbow', name: 'å³è‚˜å…³èŠ‚', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_wrist_roll', name: 'å³è…•æ—‹è½¬', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_wrist_pitch', name: 'å³è…•ä¿¯ä»°', min: -3.14, max: 3.14, step: 0.01, value: 0.0 },
                { id: 'right_wrist_yaw', name: 'å³è…•åèˆª', min: -3.14, max: 3.14, step: 0.01, value: 0.0 }
            ]
        };

        // é¢„è®¾åŠ¨ä½œé…ç½®
        const G1_PRESET_POSITIONS = {
            home: [0.2, 0.1, 0.0, -0.3, 0.0, 0.0, 0.0, 0.2, -0.1, 0.0, -0.3, 0.0, 0.0, 0.0],
            stretch: [0.0, 1.57, 0.0, 1.57, 0.0, 0.0, 0.0, 0.0, -1.57, 0.0, 1.57, 0.0, 0.0, 0.0],
            wave_left: [0.8, 1.57, 0.0, 1.57, 0.5, 0.0, 0.0, 0.0, -1.57, 0.0, 1.57, 0.0, 0.0, 0.0],
            wave_right: [0.0, 1.57, 0.0, 1.57, 0.0, 0.0, 0.0, 0.8, -1.57, 0.0, 1.57, -0.5, 0.0, 0.0],
            grab: [0.0, 1.57, 0.0, 1.57, 0.0, 0.5, 0.3, 0.0, -1.57, 0.0, 1.57, 0.0, 0.5, -0.3],
            zero: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            salute: [0.0, 1.57, 0.0, 1.57, 0.0, 0.0, 0.0, 0.8, -1.57, 0.0, 0.5, 0.0, 0.0, 0.0],
            tpose: [0.0, 1.57, 0.0, 1.57, 0.0, 0.0, 0.0, 0.0, -1.57, 0.0, 1.57, 0.0, 0.0, 0.0],
            relax: [0.5, 0.3, 0.0, -0.8, 0.0, 0.0, 0.0, 0.5, -0.3, 0.0, -0.8, 0.0, 0.0, 0.0]
        };

        let g1MqttClient = null;
        let g1IsConnected = false;
        const g1CurrentPositions = {};
        let g1SendDebounceTimer = null;
        const G1_SEND_DEBOUNCE_DELAY = 50; // 50msé˜²æŠ–å»¶è¿Ÿ
        let g1FirstConnection = true; // æ·»åŠ é¦–æ¬¡è¿æ¥æ ‡å¿—

        // åˆå§‹åŒ–G1æœºæ¢°è‡‚é¡µé¢
        function g1InitializePage() {
            g1GenerateJointControls('g1_leftArmControls', G1_JOINT_CONFIG.leftArm);
            g1GenerateJointControls('g1_rightArmControls', G1_JOINT_CONFIG.rightArm);
            g1PopulateJointSelect();
            g1ConnectMQTT();
        }

        // ç”ŸæˆG1å…³èŠ‚æ§åˆ¶ç•Œé¢
        function g1GenerateJointControls(containerId, joints) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';

            joints.forEach(joint => {
                g1CurrentPositions[joint.id] = joint.value;
                
                const jointControl = document.createElement('div');
                jointControl.className = 'g1-joint-control';
                jointControl.innerHTML = `
                    <div class="g1-joint-header">
                        <div class="g1-joint-name">${joint.name}</div>
                        <div class="g1-joint-value" id="g1_${joint.id}_value">
                            ${joint.value.toFixed(3)}
                            <span class="g1-sending-indicator" id="g1_${joint.id}_sending">ğŸ”„</span>
                        </div>
                    </div>
                    <div class="g1-slider-container">
                        <input type="range" 
                               id="g1_${joint.id}_slider" 
                               min="${joint.min}" 
                               max="${joint.max}" 
                               step="${joint.step}" 
                               value="${joint.value}"
                               oninput="g1HandleJointInput('${joint.id}', this.value)"
                               onchange="g1HandleJointChange('${joint.id}', this.value)">
                        <input type="number" 
                               id="g1_${joint.id}_input" 
                               min="${joint.min}" 
                               max="${joint.max}" 
                               step="${joint.step}" 
                               value="${joint.value}"
                               onchange="g1HandleJointChange('${joint.id}', this.value)">
                    </div>
                `;
                container.appendChild(jointControl);
            });
        }

        // å¡«å……G1å…³èŠ‚é€‰æ‹©ä¸‹æ‹‰æ¡†
        function g1PopulateJointSelect() {
            const select = document.getElementById('g1_jointSelect');
            if (!select) return;
            
            select.innerHTML = '';
            
            [...G1_JOINT_CONFIG.leftArm, ...G1_JOINT_CONFIG.rightArm].forEach(joint => {
                const option = document.createElement('option');
                option.value = joint.id;
                option.textContent = joint.name;
                select.appendChild(option);
            });
        }

        // å¤„ç†G1å…³èŠ‚è¾“å…¥ï¼ˆå®æ—¶æ›´æ–°æ˜¾ç¤ºï¼‰
        function g1HandleJointInput(jointId, value) {
            const numValue = parseFloat(value);
            g1CurrentPositions[jointId] = numValue;
            
            // æ›´æ–°æ˜¾ç¤º
            const valueSpan = document.getElementById(`g1_${jointId}_value`);
            if (valueSpan) {
                valueSpan.firstChild.textContent = numValue.toFixed(3);
            }
            
            const numberInput = document.getElementById(`g1_${jointId}_input`);
            if (numberInput && numberInput !== document.activeElement) {
                numberInput.value = numValue;
            }
        }

        // å¤„ç†G1å…³èŠ‚å˜åŒ–ï¼ˆå‘é€å‘½ä»¤ï¼‰
        function g1HandleJointChange(jointId, value) {
            const numValue = parseFloat(value);
            g1CurrentPositions[jointId] = numValue;
            
            // æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºå…ƒç´ 
            const slider = document.getElementById(`g1_${jointId}_slider`);
            const numberInput = document.getElementById(`g1_${jointId}_input`);
            const valueSpan = document.getElementById(`g1_${jointId}_value`);
            
            if (slider) slider.value = numValue;
            if (numberInput) numberInput.value = numValue;
            if (valueSpan) valueSpan.firstChild.textContent = numValue.toFixed(3);
            
            // å‘é€å•ä¸ªå…³èŠ‚å‘½ä»¤
            g1SendJointCommand(jointId, numValue);
        }

        // å‘é€G1å•ä¸ªå…³èŠ‚å‘½ä»¤
        function g1SendJointCommand(jointId, value) {
            if (!g1MqttClient || !g1IsConnected) {
                g1AddLog('MQTTæœªè¿æ¥ï¼Œæ— æ³•å‘é€å‘½ä»¤', 'error');
                return;
            }
            
            const command = {
                joint_control: {
                    joint_name: jointId,
                    position: value
                }
            };
            
            g1PublishCommand(command);
            g1AddLog(`è®¾ç½® ${jointId} ä½ç½®: ${value.toFixed(3)}`);
        }

        // å‘é€G1æ‰€æœ‰å…³èŠ‚ä½ç½®
        function g1SendAllJoints() {
            const positions = [];
            [...G1_JOINT_CONFIG.leftArm, ...G1_JOINT_CONFIG.rightArm].forEach(joint => {
                positions.push(g1CurrentPositions[joint.id] || 0);
            });
            
            const command = {
                enable: true,
                positions: positions
            };
            
            g1PublishCommand(command);
            g1AddLog('å‘é€æ‰€æœ‰å…³èŠ‚ä½ç½®');
        }

        // è¿æ¥G1 MQTT - ä¿®å¤åçš„ç‰ˆæœ¬
        function g1ConnectMQTT() {
            try {
                const wsUrl = `ws://${G1_MQTT_CONFIG.broker}:${G1_MQTT_CONFIG.port}/mqtt`;
                
                // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆæ¸…ç†
                if (g1MqttClient) {
                    try {
                        g1MqttClient.end(true);
                    } catch (e) {
                        console.log('å…³é—­æ—§G1 MQTTè¿æ¥æ—¶å‡ºé”™:', e);
                    }
                    g1MqttClient = null;
                }
                
                g1UpdateConnectionStatus(false, 'ğŸŸ¡ è¿æ¥ä¸­...');
                g1AddLog('æ­£åœ¨è¿æ¥åˆ°MQTTæœåŠ¡å™¨...');
                
                // åˆ›å»ºæ–°è¿æ¥ï¼Œä½¿ç”¨ä¸ç¬¬äºŒä¸ªæ–‡ä»¶ç›¸åŒçš„é…ç½®
                g1MqttClient = mqtt.connect(wsUrl, {
                    clientId: G1_MQTT_CONFIG.clientId,
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 3000,  // 3ç§’åè‡ªåŠ¨é‡è¿
                    keepalive: 60
                });
                
                g1MqttClient.on('connect', function() {
                    g1IsConnected = true;
                    g1UpdateConnectionStatus(true, 'âœ… å·²è¿æ¥åˆ°MQTTæœåŠ¡å™¨');
                    g1AddLog('è¿æ¥åˆ°MQTTæœåŠ¡å™¨æˆåŠŸ');
                    
                    // è®¢é˜…ä¸»é¢˜
                    g1MqttClient.subscribe(G1_MQTT_CONFIG.topicState, function(err) {
                        if (err) {
                            g1AddLog('è®¢é˜…çŠ¶æ€ä¸»é¢˜å¤±è´¥: ' + err, 'error');
                        } else {
                            g1AddLog(`å·²è®¢é˜…çŠ¶æ€ä¸»é¢˜: ${G1_MQTT_CONFIG.topicState}`);
                        }
                    });
                    
                    // é¦–æ¬¡è¿æ¥æ—¶è‡ªåŠ¨å¯ç”¨æœºæ¢°è‡‚
                    if (g1FirstConnection) {
                        g1FirstConnection = false;
                        setTimeout(() => {
                            g1EnableArm();
                            g1AddLog('é¦–æ¬¡è¿æ¥ï¼Œè‡ªåŠ¨å¯ç”¨æœºæ¢°è‡‚');
                        }, 1000);
                    }
                });
                
                g1MqttClient.on('error', function(error) {
                    g1IsConnected = false;
                    g1UpdateConnectionStatus(false, 'âŒ MQTTè¿æ¥é”™è¯¯');
                    g1AddLog('MQTTè¿æ¥é”™è¯¯: ' + error.message, 'error');
                });
                
                g1MqttClient.on('close', function() {
                    g1IsConnected = false;
                    g1UpdateConnectionStatus(false, 'âŒ MQTTè¿æ¥å·²æ–­å¼€');
                    g1AddLog('MQTTè¿æ¥æ–­å¼€ï¼Œå°†è‡ªåŠ¨é‡è¿...', 'warning');
                });
                
                g1MqttClient.on('reconnect', function() {
                    g1AddLog('æ­£åœ¨å°è¯•é‡æ–°è¿æ¥MQTT...', 'info');
                });
                
                g1MqttClient.on('message', function(topic, message) {
                    if (topic === G1_MQTT_CONFIG.topicState) {
                        try {
                            const data = JSON.parse(message.toString());
                            g1HandleStateMessage(data);
                        } catch (e) {
                            g1AddLog(`çŠ¶æ€æ¶ˆæ¯è§£æé”™è¯¯: ${e}`, 'error');
                        }
                    }
                });
                
            } catch (error) {
                g1UpdateConnectionStatus(false, 'âŒ è¿æ¥å¤±è´¥');
                g1AddLog('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†G1çŠ¶æ€æ¶ˆæ¯
        function g1HandleStateMessage(data) {
            if (data.arm_enabled !== undefined) {
                // æ›´æ–°æœºæ¢°è‡‚å¯ç”¨çŠ¶æ€
                const statusText = data.arm_enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
                g1AddLog(`æœºæ¢°è‡‚çŠ¶æ€: ${statusText}`);
            }
            
            if (data.positions && Array.isArray(data.positions)) {
                // æ›´æ–°å…³èŠ‚ä½ç½®æ˜¾ç¤º
                g1UpdateJointSliders(data.positions);
            }
        }

        // æ›´æ–°G1å…³èŠ‚æ»‘å—ä½ç½®
        function g1UpdateJointSliders(positions) {
            const allJoints = [...G1_JOINT_CONFIG.leftArm, ...G1_JOINT_CONFIG.rightArm];
            
            allJoints.forEach((joint, index) => {
                if (index < positions.length) {
                    const newValue = positions[index];
                    g1CurrentPositions[joint.id] = newValue;
                    
                    const slider = document.getElementById(`g1_${joint.id}_slider`);
                    const numberInput = document.getElementById(`g1_${joint.id}_input`);
                    const valueSpan = document.getElementById(`g1_${joint.id}_value`);
                    
                    if (slider) slider.value = newValue;
                    if (numberInput) numberInput.value = newValue;
                    if (valueSpan) valueSpan.firstChild.textContent = newValue.toFixed(3);
                }
            });
        }

        // æ›´æ–°G1è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function g1UpdateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('g1_connectionStatus');
            const statusText = document.getElementById('g1_statusText');
            
            g1IsConnected = connected;
            if (statusElement) {
                statusElement.className = connected ? 
                    'g1-connection-status g1-connected' : 
                    'g1-connection-status g1-disconnected';
            }
            if (statusText) {
                statusText.textContent = message;
            }
        }

        // å‘å¸ƒG1å‘½ä»¤åˆ°MQTT
        function g1PublishCommand(command) {
            if (!g1MqttClient || !g1IsConnected) {
                g1AddLog('MQTTæœªè¿æ¥ï¼Œæ— æ³•å‘é€å‘½ä»¤', 'error');
                return false;
            }
            
            try {
                const payload = JSON.stringify(command);
                g1MqttClient.publish(G1_MQTT_CONFIG.topicCmd, payload);
                return true;
            } catch (error) {
                g1AddLog('å‘é€å‘½ä»¤å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // å¯ç”¨G1æœºæ¢°è‡‚
        function g1EnableArm() {
            const command = { enable: true };
            if (g1PublishCommand(command)) {
                g1AddLog('å¯ç”¨æœºæ¢°è‡‚æ§åˆ¶', 'success');
            }
        }

        // ç¦ç”¨G1æœºæ¢°è‡‚
        function g1DisableArm() {
            const command = { enable: false };
            if (g1PublishCommand(command)) {
                g1AddLog('ç¦ç”¨æœºæ¢°è‡‚æ§åˆ¶', 'warning');
            }
        }

        // åœæ­¢G1æœºæ¢°è‡‚
        function g1StopArm() {
            g1DisableArm();
            // é‡ç½®æ‰€æœ‰ä½ç½®ä¸ºé›¶
            const zeroPositions = new Array(14).fill(0);
            setTimeout(() => {
                const command = { enable: true, positions: zeroPositions };
                g1PublishCommand(command);
                g1AddLog('ç´§æ€¥åœæ­¢:å·²ç¦ç”¨æœºæ¢°è‡‚å¹¶é‡ç½®ä½ç½®', 'warning');
                g1UpdateInterfaceWithPreset('zero');
            }, 100);
        }

        // å‘é€G1é¢„è®¾åŠ¨ä½œ
        function g1SendPreset(presetName) {
            if (G1_PRESET_POSITIONS[presetName]) {
                const command = {
                    enable: true,
                    positions: G1_PRESET_POSITIONS[presetName]
                };
                
                if (g1PublishCommand(command)) {
                    g1AddLog(`å‘é€é¢„è®¾åŠ¨ä½œ: ${presetName}`, 'success');
                    g1UpdateInterfaceWithPreset(presetName);
                }
            } else {
                g1AddLog(`æœªçŸ¥çš„é¢„è®¾åŠ¨ä½œ: ${presetName}`, 'error');
            }
        }

        // æ›´æ–°G1ç•Œé¢æ˜¾ç¤ºé¢„è®¾å€¼
        function g1UpdateInterfaceWithPreset(presetName) {
            const positions = G1_PRESET_POSITIONS[presetName];
            if (!positions) return;
            
            const allJoints = [...G1_JOINT_CONFIG.leftArm, ...G1_JOINT_CONFIG.rightArm];
            
            allJoints.forEach((joint, index) => {
                if (index < positions.length) {
                    g1CurrentPositions[joint.id] = positions[index];
                    
                    const slider = document.getElementById(`g1_${joint.id}_slider`);
                    const numberInput = document.getElementById(`g1_${joint.id}_input`);
                    const valueSpan = document.getElementById(`g1_${joint.id}_value`);
                    
                    if (slider) slider.value = positions[index];
                    if (numberInput) numberInput.value = positions[index];
                    if (valueSpan) valueSpan.firstChild.textContent = positions[index].toFixed(3);
                }
            });
        }

        // å‘é€G1å•ä¸ªå…³èŠ‚å‘½ä»¤(é€šè¿‡è¾“å…¥æ¡†)
        function g1SendSingleJoint() {
            const jointSelect = document.getElementById('g1_jointSelect');
            const positionInput = document.getElementById('g1_positionInput');
            
            if (!jointSelect || !positionInput) return;
            
            const jointName = jointSelect.value;
            const position = parseFloat(positionInput.value);
            
            if (jointName && !isNaN(position)) {
                g1SendJointCommand(jointName, position);
                
                // æ›´æ–°ç•Œé¢
                g1CurrentPositions[jointName] = position;
                const slider = document.getElementById(`g1_${jointName}_slider`);
                const numberInput = document.getElementById(`g1_${jointName}_input`);
                const valueSpan = document.getElementById(`g1_${jointName}_value`);
                
                if (slider) slider.value = position;
                if (numberInput) numberInput.value = position;
                if (valueSpan) valueSpan.firstChild.textContent = position.toFixed(3);
            }
        }

        // æ·»åŠ G1æ—¥å¿—
        function g1AddLog(message, type = 'info') {
            const logContent = document.getElementById('g1_logContent');
            if (!logContent) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'g1-log-entry';
            
            let prefix = '[ç³»ç»Ÿ]';
            if (type === 'success') prefix = '[æˆåŠŸ]';
            if (type === 'error') prefix = '[é”™è¯¯]';
            if (type === 'warning') prefix = '[è­¦å‘Š]';
            
            logEntry.innerHTML = `<span class="g1-timestamp">[${timestamp}]</span> ${prefix} ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            const entries = logContent.getElementsByClassName('g1-log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }

        // æ¸…ç©ºG1æ—¥å¿—
        function g1ClearLog() {
            const logContent = document.getElementById('g1_logContent');
            if (logContent) {
                logContent.innerHTML = '';
                g1AddLog('æ—¥å¿—å·²æ¸…ç©º');
            }
        }

        // ==========================================================
        // æœºå™¨äººç±»å‹åˆ‡æ¢å‡½æ•°
        // ==========================================================
        function updateRobotSpecificControls() {
            // éšè—æ‰€æœ‰ç‰¹å®šæ§åˆ¶ç•Œé¢
            document.querySelectorAll('.robot-specific-control').forEach(control => {
                control.classList.remove('active');
            });
            
            // æ›´æ–°æ‘„åƒå¤´æ˜¾ç¤ºåŒºåŸŸ
            const go2ArmCameraItem = document.getElementById('go2-arm-camera-item');
            const g1CameraContainer = document.getElementById('g1-camera-container');
            
            if (currentRobotConfig) {
                if (currentRobotConfig.type === 'go2') {
                    // æ˜¾ç¤ºGO2æ§åˆ¶ç•Œé¢
                    document.getElementById('go2-arm-control').classList.add('active');
                    document.getElementById('speed-control-hint').textContent = 'å½“å‰æ§åˆ¶æ¨¡å¼ï¼šå››è¶³æœºå™¨äººç§»åŠ¨æ§åˆ¶';
                    document.getElementById('arm-control-hint').textContent = 'å½“å‰æ§åˆ¶æ¨¡å¼ï¼šGO2æœºæ¢°è‡‚æ§åˆ¶';
                    
                    // æ˜¾ç¤ºGO2æœºæ¢°è‡‚æ‘„åƒå¤´ï¼Œéšè—G1æ‘„åƒå¤´
                    if (go2ArmCameraItem) go2ArmCameraItem.style.display = 'block';
                    if (g1CameraContainer) g1CameraContainer.style.display = 'none';
                    
                } else if (currentRobotConfig.type === 'g1') {
                    // æ˜¾ç¤ºG1æ§åˆ¶ç•Œé¢
                    document.getElementById('g1-arm-control').classList.add('active');
                    document.getElementById('speed-control-hint').textContent = 'å½“å‰æ§åˆ¶æ¨¡å¼ï¼šG1æœºå™¨äººç§»åŠ¨æ§åˆ¶';
                    document.getElementById('arm-control-hint').textContent = 'å½“å‰æ§åˆ¶æ¨¡å¼ï¼šG1åŒæœºæ¢°è‡‚æ§åˆ¶';
                    
                    // éšè—GO2æœºæ¢°è‡‚æ‘„åƒå¤´ï¼Œæ˜¾ç¤ºG1æ‘„åƒå¤´
                    if (go2ArmCameraItem) go2ArmCameraItem.style.display = 'none';
                    if (g1CameraContainer) g1CameraContainer.style.display = 'flex';
                    
                    // æ›´æ–°G1æ‘„åƒå¤´è§†é¢‘æµ
                    updateG1CameraStreams();
                }
            } else {
                document.getElementById('speed-control-hint').textContent = 'è¯·é€‰æ‹©æœºå™¨äººç±»å‹ä»¥æ˜¾ç¤ºç›¸åº”çš„æ§åˆ¶ç•Œé¢';
                document.getElementById('arm-control-hint').textContent = 'è¯·é€‰æ‹©æœºå™¨äººç±»å‹ä»¥æ˜¾ç¤ºç›¸åº”çš„æœºæ¢°è‡‚æ§åˆ¶ç•Œé¢';
                
                // é»˜è®¤æ˜¾ç¤ºGO2æœºæ¢°è‡‚æ‘„åƒå¤´
                if (go2ArmCameraItem) go2ArmCameraItem.style.display = 'block';
                if (g1CameraContainer) g1CameraContainer.style.display = 'none';
            }
        }

        // æ›´æ–°G1æ‘„åƒå¤´è§†é¢‘æµ
        function updateG1CameraStreams() {
            if (!currentRobotConfig || currentRobotConfig.type !== 'g1') return;
            
            const leftCamera = document.getElementById('g1_left_camera');
            const rightCamera = document.getElementById('g1_right_camera');
            
            if (leftCamera && currentRobotConfig.left_camera_port) {
                leftCamera.src = `http://${currentRobotConfig.ip}:${currentRobotConfig.left_camera_port}/video_stream`;
            }
            
            if (rightCamera && currentRobotConfig.right_camera_port) {
                rightCamera.src = `http://${currentRobotConfig.ip}:${currentRobotConfig.right_camera_port}/video_stream`;
            }
        }

        // ==========================================================
        // åŸæœ‰ROSæ§åˆ¶å‡½æ•°
        // ==========================================================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // å¦‚æœæ˜¯æœºæ¢°è‡‚æ§åˆ¶é€‰é¡¹å¡ï¼Œæ ¹æ®æœºå™¨äººç±»å‹åˆå§‹åŒ–ç›¸åº”çš„æ§åˆ¶
                    if (tabId === 'arm-control') {
                        if (currentRobotConfig && currentRobotConfig.type === 'go2') {
                            armInitPage();
                        } else if (currentRobotConfig && currentRobotConfig.type === 'g1') {
                            g1InitializePage();
                        }
                    }
                });
            });
        }

        function mapValueToRVizColor(normalizedValue) {
            const hue = (1.0 - normalizedValue) * 0.66;
            const saturation = 1.0;
            const lightness = 0.5;

            color.setHSL(hue, saturation, lightness);
            return { r: color.r, g: color.g, b: color.b };
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2c3e50);

            camera = new THREE.PerspectiveCamera(75, cloudDiv.clientWidth / cloudDiv.clientHeight, 0.1, 1000);
            camera.position.set(3, 3, 3);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(cloudDiv.clientWidth, cloudDiv.clientHeight);
            cloudDiv.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.update();

            scene.add(new THREE.GridHelper(10, 10, 0x7f8c8d, 0x7f8c8d));
            scene.add(new THREE.AxesHelper(1.0));

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }

        function onWindowResize() {
            if (!camera || !renderer) return;
            const width = cloudDiv.clientWidth;
            const height = cloudDiv.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }
        
        /**
         * @description å¤„ç†å¹¶æ‰§è¡Œé‡è¿é€»è¾‘ï¼Œæ£€æŸ¥é‡è¿æ¬¡æ•°ã€‚
         */
        function attemptReconnect() {
            if (currentReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                currentReconnectAttempts++;
                const delay = 5000; // 5ç§’é‡è¿é—´éš”
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢å†²çª
                if (reconnectTimerId) clearTimeout(reconnectTimerId); 

                statusText.innerText = `å°è¯•é‡è¿ä¸­ (${currentReconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`;
                statusText.style.color = 'red';
                
                reconnectTimerId = setTimeout(() => {
                    isAttemptingReconnect = true; // ç¡®ä¿ä¸‹ä¸€ä¸ª startConnection çŸ¥é“æ˜¯é‡è¯•
                    startConnection();
                }, delay);

            } else {
                statusText.innerText = `è¿æ¥å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (${MAX_RECONNECT_ATTEMPTS})ã€‚è¯·æ‰‹åŠ¨é‡è¯•æˆ–æ£€æŸ¥æœºå™¨äººã€‚`;
                statusText.style.color = 'red';
                // åœæ­¢å¾ªç¯
                isAttemptingReconnect = false; 
                currentReconnectAttempts = 0; // å¤±è´¥åé‡ç½®ä¸º0ï¼Œç­‰å¾…ç”¨æˆ·ä¸‹æ¬¡æ“ä½œ
            }
        }

        /**
         * @description å…³é—­å½“å‰çš„ ROS è¿æ¥å’Œè®¢é˜…ã€‚
         */
        function disconnect() {
            if (reconnectTimerId) {
                clearTimeout(reconnectTimerId);
                reconnectTimerId = null;
            }

            if (cloudTopicSubscriber) {
                cloudTopicSubscriber.unsubscribe();
                cloudTopicSubscriber = null;
            }

            cmdVel = null;
            sportApiTopic = null;

            if (ros) { 
                stopRobot();
                ros.removeAllListeners();

                if (ros.isConnected) {
                    ros.close(); 
                }
                
                ros = null; 
                console.log('Closed and nullified old ROS Bridge connection object.');
            }
            
            if (pointCloudObject) {
                scene.remove(pointCloudObject);
                pointCloudObject.geometry.dispose();
                pointCloudObject = null;
            }
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šæ¯æ¬¡æ‰‹åŠ¨æ–­å¼€æ—¶ï¼Œé‡ç½®é‡è¿æ ‡å¿—å’Œæ¬¡æ•°
            isAttemptingReconnect = false;
            isManualOperation = false;
            currentReconnectAttempts = 0; 
        }

        /**
         * @description æ ¹æ®å½“å‰çš„ currentRobotConfig å»ºç«‹æ–°çš„ ROS è¿æ¥ã€‚
         */
        function startConnection() {
            
            // å¦‚æœæ˜¯æ‰‹åŠ¨æ“ä½œè§¦å‘ï¼Œåˆ™å…ˆè¿›è¡Œå…¨é¢æ¸…ç†
            if (isManualOperation) {
                disconnect(); 
            } else if (ros) {
                 // å¦‚æœæ˜¯è‡ªåŠ¨é‡è¿ï¼Œåªéœ€è¦æ¸…ç†æ—§çš„ ros å®ä¾‹å¼•ç”¨ï¼Œé¿å…æ³„éœ²
                 ros.removeAllListeners();
                 ros = null; 
            }
            
            if (!currentRobotConfig) {
                statusText.innerText = 'æœªé€‰æ‹©æœºå™¨äºº';
                statusText.style.color = 'gray';
                return;
            }

            const rosbridgeUrl = `ws://${currentRobotConfig.ip}:${ROSBRIDGE_PORT}`;
            statusText.innerText = `å°è¯•è¿æ¥ ${currentRobotConfig.ip}...`;
            statusText.style.color = 'orange';

            ros = new ROSLIB.Ros({ url: rosbridgeUrl });

            ros.on('connection', () => {
                console.log(`Connected to ROS Bridge at ${currentRobotConfig.ip}`);
                statusText.innerText = 'å·²è¿æ¥';
                statusText.style.color = 'green';
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šè¿æ¥æˆåŠŸï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€
                isAttemptingReconnect = false;
                isManualOperation = false;
                currentReconnectAttempts = 0;
                
                // åˆå§‹åŒ–å‘å¸ƒå™¨å’Œè®¢é˜…
                cmdVel = new ROSLIB.Topic({ ros: ros, name: CMD_VEL_TOPIC, messageType: 'geometry_msgs/Twist' });
                sportApiTopic = new ROSLIB.Topic({ ros: ros, name: SPORT_API_TOPIC, messageType: SPORT_API_MSG_TYPE });
                subscribePointCloud();
            });

            ros.on('error', (error) => {
                console.error('Error connecting to ROS: ', error);
                ros = null; // æ¸…é™¤å¼•ç”¨
                
                // å¦‚æœæ˜¯ç”¨æˆ·æ“ä½œï¼ˆé¦–æ¬¡å°è¯•ï¼‰å¤±è´¥ï¼Œåˆ™åœæ­¢é‡è¯•
                if (!isAttemptingReconnect) {
                    statusText.innerText = `è¿æ¥ ${currentRobotConfig.ip} å¤±è´¥ - æœºå™¨äººæœªå¼€æœºæˆ–ç½‘ç»œé”™è¯¯ã€‚`;
                    statusText.style.color = 'red';
                    return;
                }
                
                // å¦‚æœæ˜¯åœ¨é‡è¿å¾ªç¯ä¸­å‘ç”Ÿé”™è¯¯ï¼Œç»§ç»­å°è¯•
                attemptReconnect();
            });

            ros.on('close', () => {
                if (isManualOperation) { 
                     console.log(`Disconnected manually from ROS at ${currentRobotConfig.ip}.`);
                     statusText.innerText = 'å·²æ–­å¼€';
                     statusText.style.color = 'red';
                     return;
                }

                // æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯éæ‰‹åŠ¨ä¸” ros å¼•ç”¨æœªæ¸…ç† (å³æ„å¤–æ–­å¼€)
                if (ros !== null) { 
                    console.log(`Disconnected unexpectedly from ROS at ${currentRobotConfig.ip}. Initiating reconnect sequence.`);
                    ros = null; // ç«‹å³æ¸…é™¤å¼•ç”¨ï¼Œé˜²æ­¢æ³„éœ²
                    
                    // å¯åŠ¨é‡è¿é€»è¾‘
                    attemptReconnect();
                }
            });

            // æ›´æ–°è§†é¢‘æµ URL
            videoDisplay.src = `http://${currentRobotConfig.ip}:${currentRobotConfig.video_port}/video_stream`;
            
            // æ›´æ–°æœºæ¢°è‡‚æ‘„åƒå¤´è§†é¢‘æµ - ä½¿ç”¨ç«¯å£5001
            if (currentRobotConfig.arm_camera_port) {
                armVideoDisplay.src = `http://${currentRobotConfig.ip}:${currentRobotConfig.arm_camera_port}/video_stream`;
            }
            
            // æ›´æ–°G1æ‘„åƒå¤´è§†é¢‘æµ
            updateG1CameraStreams();
        }

        /**
         * @description æ ¹æ®é€‰æ‹©åˆ‡æ¢æœºå™¨äººé…ç½®å¹¶é‡æ–°è¿æ¥ã€‚
         */
        function switchRobot(robotKey) {
            currentRobotConfig = ROBOTS_CONFIG[robotKey];
            // æ ¸å¿ƒä¿®æ”¹ï¼šæ ‡è®°ä¸ºæ‰‹åŠ¨æ“ä½œï¼Œå¹¶é‡ç½®æ‰€æœ‰çŠ¶æ€
            isAttemptingReconnect = false; 
            isManualOperation = true; 
            currentReconnectAttempts = 0;
            
            // æ›´æ–°ç‰¹å®šæ§åˆ¶ç•Œé¢
            updateRobotSpecificControls();
            
            startConnection();
        }

        function parsePointCloud2(message) {
            if (!message.data || message.data.length === 0 || message.height * message.width === 0) {
                return null;
            }

            let xOffset = -1, yOffset = -1, zOffset = -1;
            const pointStep = message.point_step;

            message.fields.forEach(field => {
                if (field.name === 'x') xOffset = field.offset;
                if (field.name === 'y') yOffset = field.offset;
                if (field.name === 'z') zOffset = field.offset;
            });

            if (xOffset === -1 || yOffset === -1 || zOffset === -1) {
                console.error("PointCloud2 æ¶ˆæ¯ä¸­æœªæ‰¾åˆ° x, y, z å­—æ®µ!");
                return null;
            }

            const binaryString = atob(message.data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const dataLength = bytes.length;
            const numPointsExpected = Math.floor(dataLength / pointStep);
            const positions = new Float32Array(numPointsExpected * 3);
            const colors = new Float32Array(numPointsExpected * 3);

            const dataView = new DataView(bytes.buffer);
            let dataIndex = 0;
            let colorIndex = 0;
            const isLittleEndian = true;
            let actualPointsCount = 0;

            for (let byteOffset = 0;
                 byteOffset + pointStep <= dataLength;
                 byteOffset += pointStep)
            {
                try {
                    const rawX = dataView.getFloat32(byteOffset + xOffset, isLittleEndian);
                    const rawY = dataView.getFloat32(byteOffset + yOffset, isLittleEndian);
                    const rawZ = dataView.getFloat32(byteOffset + zOffset, isLittleEndian);

                    const distance = Math.sqrt(rawX * rawX + rawY * rawY + rawZ * rawZ);

                    const threeX = rawX;
                    const threeY = rawZ;
                    const threeZ = -rawY;

                    positions[dataIndex++] = threeX;
                    positions[dataIndex++] = threeY;
                    positions[dataIndex++] = threeZ;

                    const normalizedValue = THREE.MathUtils.clamp(
                        (distance - COLOR_MAP_MIN_DISTANCE) / (COLOR_MAP_MAX_DISTANCE - COLOR_MAP_MIN_DISTANCE),
                        0.0,
                        1.0
                    );

                    const {r, g, b} = mapValueToRVizColor(normalizedValue);

                    colors[colorIndex++] = r;
                    colors[colorIndex++] = g;
                    colors[colorIndex++] = b;

                    actualPointsCount++;
                } catch (e) {
                    break;
                }
            }

            if (actualPointsCount === 0) {
                 return null;
            }

            const actualPositions = positions.slice(0, dataIndex);
            const actualColors = colors.slice(0, colorIndex);

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(actualPositions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(actualColors, 3));
            geometry.computeBoundingSphere();

            return geometry;
        }

        function subscribePointCloud() {
            if (cloudTopicSubscriber) {
                cloudTopicSubscriber.unsubscribe();
            }

            cloudTopicSubscriber = new ROSLIB.Topic({
                ros: ros,
                name: POINT_CLOUD_TOPIC,
                messageType: 'sensor_msgs/PointCloud2',
                compression: 'none'
            });

            cloudTopicSubscriber.subscribe((message) => {
                const geometry = parsePointCloud2(message);

                if (geometry) {
                    if (pointCloudObject) {
                        scene.remove(pointCloudObject);
                        pointCloudObject.geometry.dispose();
                    }

                    const material = new THREE.PointsMaterial({
                        size: POINT_SIZE,
                        vertexColors: true,
                        sizeAttenuation: false
                    });

                    pointCloudObject = new THREE.Points(geometry, material);
                    scene.add(pointCloudObject);
                }
            });
            console.log(`ğŸ“¡ Subscribing to ${POINT_CLOUD_TOPIC} on ${currentRobotConfig.ip}...`);
        }

        function getSpeeds() {
            const linear_x = parseFloat(document.getElementById('linear_x_speed').value) || 0;
            const linear_y = parseFloat(document.getElementById('linear_y_speed').value) || 0;
            const angular_z = parseFloat(document.getElementById('angular_z_speed').value) || 0;
            return { linear_x, linear_y, angular_z };
        }

        function stopRobot() {
            currentLinearX = 0.0;
            currentLinearY = 0.0;
            currentAngularZ = 0.0;
            publishCurrentTwist();
        }

        function publishCurrentTwist() {
            if (!cmdVel || !ros || ros.isClosed || !ros.isConnected) { 
                console.warn('ROS Bridge æœªè¿æ¥æˆ– cmd_vel è¯é¢˜æœªåˆå§‹åŒ–!');
                return;
            }

            const twist = new ROSLIB.Message({
                linear: { x: currentLinearX, y: currentLinearY, z: 0.0 },
                angular: { x: 0.0, y: 0.0, z: currentAngularZ }
            });
            cmdVel.publish(twist);
        }

        function sendSportApiRequest() {
            if (!sportApiTopic || !ros || !ros.isConnected) {
                console.warn('ROS Bridge æœªè¿æ¥æˆ– sportApiTopic è¯é¢˜æœªåˆå§‹åŒ–!');
                return;
            }

            const api_id_str = apiControlSelect.value;
            const api_id = parseInt(api_id_str);

            if (isNaN(api_id)) {
                console.error('æ— æ•ˆçš„ API ID:', api_id_str);
                return;
            }

            console.log(`Sending Sport API Request: ${apiControlSelect.options[apiControlSelect.selectedIndex].text} (ID: ${api_id})`);

            const apiRequest = new ROSLIB.Message({
                header: {
                    identity: {
                        api_id: api_id
                    },
                },
            });

            sportApiTopic.publish(apiRequest);
        }

        // ä¿å­˜æ‘„åƒå¤´å›¾åƒ
        function saveCameraImage(imgId, filename) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth || img.videoWidth || img.width;
            canvas.height = img.naturalHeight || img.videoHeight || img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const link = document.createElement('a');
            link.download = filename + '_' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // å¯åŠ¨ç¨‹åºå’Œäº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            setupTabs(); // åˆå§‹åŒ–é€‰é¡¹å¡
            window.addEventListener('resize', onWindowResize, false);

            Object.keys(ROBOTS_CONFIG).forEach(key => {
                const config = ROBOTS_CONFIG[key];
                const option = document.createElement('option');
                option.value = key; 
                option.textContent = key + ` (${config.ip})`;
                robotSelect.appendChild(option);
            });

            Object.keys(ROBOT_SPORT_API_IDS).forEach(key => {
                const id = ROBOT_SPORT_API_IDS[key];
                const option = document.createElement('option');
                option.value = id; 
                option.textContent = `${key} (${id})`;
                apiControlSelect.appendChild(option);
            });

            robotSelect.addEventListener('change', (e) => {
                switchRobot(e.target.value);
            });

            document.getElementById('send_api_button').addEventListener('click', sendSportApiRequest);

            if (Object.keys(ROBOTS_CONFIG).length > 0) {
                robotSelect.value = Object.keys(ROBOTS_CONFIG)[0];
                switchRobot(robotSelect.value);
            }

            document.querySelectorAll('.control-button').forEach(button => {
                const linX_dir = button.dataset.linX ? parseInt(button.dataset.linX) : 0;
                const linY_dir = button.dataset.linY ? parseInt(button.dataset.linY) : 0;
                const angZ_dir = button.dataset.angZ ? parseInt(button.dataset.angZ) : 0;

                const handleMovement = (isPressed) => {
                    if (!cmdVel || !ros || !ros.isConnected) return; 

                    const speeds = getSpeeds();

                    if (button.dataset.key === 's') {
                        stopRobot();
                    } else if (isPressed) {
                        currentLinearX = linX_dir * speeds.linear_x;
                        currentLinearY = linY_dir * speeds.linear_y;
                        currentAngularZ = angZ_dir * speeds.angular_z;
                        publishCurrentTwist();
                    } else {
                        if (linX_dir !== 0) currentLinearX = 0.0;
                        if (linY_dir !== 0) currentLinearY = 0.0;
                        if (angZ_dir !== 0) currentAngularZ = 0.0;
                        publishCurrentTwist();
                    }
                };

                button.onmousedown = button.ontouchstart = (e) => {
                    handleMovement(true);
                    e.preventDefault();
                };

                button.onmouseup = button.ontouchend = (e) => {
                    handleMovement(false);
                    e.preventDefault();
                };
            });

            document.addEventListener('keydown', (e) => {
                if (!cmdVel || !ros || !ros.isConnected) return; 

                const key = e.key.toLowerCase();
                if (keysPressed[key]) return;

                const speeds = getSpeeds();
                keysPressed[key] = true;

                switch (key) {
                    case 'w': currentLinearX = speeds.linear_x; break;
                    case 'x': currentLinearX = -speeds.linear_x; break;
                    case 'a': currentLinearY = speeds.linear_y; break;
                    case 'd': currentLinearY = -speeds.linear_y; break;
                    case 'q': currentAngularZ = speeds.angular_z; break;
                    case 'e': currentAngularZ = -speeds.angular_z; break;
                    case 's': stopRobot(); break;
                    default: return;
                }

                publishCurrentTwist();
                e.preventDefault();
            });

            document.addEventListener('keyup', (e) => {
                if (!cmdVel || !ros || !ros.isConnected) return; 

                const key = e.key.toLowerCase();
                if (!keysPressed[key]) return;

                switch (key) {
                    case 'w': case 'x': currentLinearX = 0.0; break;
                    case 'a': case 'd': currentLinearY = 0.0; break;
                    case 'q': case 'e': currentAngularZ = 0.0; break;
                    default: delete keysPressed[key]; return;
                }

                delete keysPressed[key];

                if (key !== 's') {
                    publishCurrentTwist();
                }
            });

            // ==========================================================
            // Request 2: æœ¬åœ° USB æ‘„åƒå¤´é€»è¾‘ (å…¨å±€æ‘„åƒå¤´)
            // ==========================================================
            const openUsbBtn  = document.getElementById('open_usb_cam');
            const usbVideo    = document.getElementById('usb_video');
            const saveUsbBtn  = document.getElementById('save_usb_btn');
            let   usbStream   = null;

            if (openUsbBtn) {
                openUsbBtn.onclick = async () => {
                    if (usbStream) {         // å·²ç»æ‰“å¼€ â†’ å…³é—­
                        usbStream.getTracks().forEach(t => t.stop());
                        usbVideo.srcObject = null;
                        usbStream = null;
                        openUsbBtn.textContent = 'æ‰“å¼€';
                        // ç¦ç”¨ä¿å­˜æŒ‰é’®
                        saveUsbBtn.disabled = true;
                        saveUsbBtn.style.backgroundColor = '#7f8c8d';
                        saveUsbBtn.style.borderColor = '#7f8c8d';
                        saveUsbBtn.style.cursor = 'not-allowed';
                        return;
                    }
                    try {
                        const constraints = { video: { width: 1280, height: 720 }, audio: false };
                        usbStream = await navigator.mediaDevices.getUserMedia(constraints);
                        usbVideo.srcObject = usbStream;
                        openUsbBtn.textContent = 'å…³é—­';
                        // å¯ç”¨ä¿å­˜æŒ‰é’®
                        saveUsbBtn.disabled = false;
                        saveUsbBtn.style.backgroundColor = '#3498db';
                        saveUsbBtn.style.borderColor = '#3498db';
                        saveUsbBtn.style.cursor = 'pointer';
                    } catch (err) {
                        alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + err.message);
                    }
                };
            }
            
            // å…¨å±€æ‘„åƒå¤´ä¿å­˜é€»è¾‘
            if (saveUsbBtn) {
                saveUsbBtn.onclick = () => {
                    if (!usbVideo || !usbVideo.srcObject) return;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = usbVideo.videoWidth;
                    canvas.height = usbVideo.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(usbVideo, 0, 0, canvas.width, canvas.height);
                    
                    const link = document.createElement('a');
                    link.download = 'global_cam_snapshot_' + Date.now() + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
            }
        });
    </script>
</body>
</html>

